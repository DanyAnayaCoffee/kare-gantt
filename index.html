<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KARE QA: Gantt Timeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .kare-orange { color: #F16B24; }
        .bg-kare-orange { background-color: #F16B24; }
        
        .gantt-scroll-container {
            overflow-x: auto;
            border-radius: 0.75rem;
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-height: 75vh;
        }

        .gantt-row {
            display: flex;
            height: 52px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            width: 320px;
            min-width: 320px;
            background: white;
            z-index: 40;
            border-right: 2px solid #F16B24;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.05);
        }

        .time-grid-container {
            position: relative;
            display: flex;
            flex-grow: 1;
        }

        .day-cell {
            min-width: 45px;
            width: 45px;
            border-right: 1px solid #f1f5f9;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .month-cell {
            height: 30px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #475569;
            background: #f1f5f9;
            flex-shrink: 0;
        }

        .gantt-bar-wrapper {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 28px;
            z-index: 20;
            transition: all 0.2s ease;
        }

        .gantt-bar {
            height: 100%;
            border-radius: 6px;
            background: #F16B24;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 10px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(241, 107, 36, 0.2);
            white-space: nowrap;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ef4444;
            z-index: 35;
            pointer-events: none;
        }

        .today-label {
            position: absolute;
            top: -22px;
            left: -18px;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 800;
        }

        .header-day {
            background: #f8fafc;
            font-weight: 700;
            color: #64748b;
            height: 40px;
        }

        .weekend { background-color: #fdf2f2; }
        
        #gantt-header-wrapper {
            position: sticky;
            top: 0;
            z-index: 50;
            background: white;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="max-w-[1600px] mx-auto flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b-4 border-[#F16B24] pb-6">
        <div class="flex items-center gap-6">
            <img src="https://www.doyoukare.com/wp-content/uploads/2021/05/cropped-Kare_Header_Logo.png" alt="KARE Logo" width="140" class="object-contain">
            <div class="h-10 w-px bg-slate-200 hidden md:block"></div>
            <div>
                <h1 class="text-xl font-black uppercase tracking-tight text-slate-800">Azure DevOps QA Roadmap</h1>
                <p class="text-slate-400 text-sm font-medium">.NET 8 Upgrade Timeline</p>
            </div>
        </div>
        <div class="mt-4 md:mt-0 flex gap-3">
            <button onclick="triggerCSV()" class="bg-[#F16B24] hover:bg-orange-600 text-white px-5 py-2.5 rounded-lg shadow-md text-xs font-bold transition-all flex items-center gap-2">
                <span>ðŸ“‚</span> LOAD AZURE CSV
            </button>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto">
        <div class="flex items-center gap-4 mb-4">
            <div id="date-range-info" class="text-[11px] font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full uppercase tracking-widest">Awaiting file upload...</div>
            <div class="h-px bg-slate-100 flex-grow"></div>
        </div>

        <div class="gantt-scroll-container">
            <div id="gantt-header-wrapper">
                <!-- Month Row -->
                <div id="gantt-month-header" class="flex border-b border-slate-200">
                    <div class="sticky-col h-[30px] bg-slate-100 border-b border-slate-200"></div>
                    <div id="header-months-container" class="flex"></div>
                </div>
                <!-- Day Row -->
                <div id="gantt-day-header" class="flex border-b border-slate-200">
                    <div class="sticky-col header-day uppercase text-[10px] tracking-widest">Task Information</div>
                    <div id="header-days-container" class="flex"></div>
                </div>
            </div>
            <div id="gantt-body" class="relative">
                <!-- Dynamically filled -->
            </div>
        </div>

        <div class="mt-6 flex flex-wrap gap-6 justify-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-sm bg-kare-orange"></div>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">QA Testing Period</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-0.5 h-4 bg-red-500"></div>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Current Day</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-sm bg-slate-100 border border-slate-200"></div>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Weekend</span>
            </div>
        </div>
    </main>

    <script>
        const dayWidth = 45;
        const stickyWidth = 320;
        
        const backupTasks = [
            { id: "4400", titulo: "Regression Testing Setup", responsable: "QA Team", inicio: "2026-02-01", fin: "2026-02-15" }
        ];

        function triggerCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => processCSV(event.target.result);
                reader.readAsText(file);
            };
            input.click();
        }

        function processCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            if (lines.length < 2) return;

            const firstLine = lines[0];
            const delimiter = firstLine.includes(';') ? ';' : ',';
            const headers = splitCSVLine(firstLine, delimiter).map(h => 
                h.trim().toLowerCase().replace(/^"|"$/g, '').replace(/^\uFEFF/, "")
            );

            const tasks = lines.slice(1).map(line => {
                const values = splitCSVLine(line, delimiter);
                const row = {};
                headers.forEach((h, i) => {
                    row[h] = values[i] ? values[i].replace(/^"|"$/g, '').trim() : '';
                });

                const id = row['id'] || '0';
                const title = row['title'] || 'Untitled';
                const owner = row['assigned to'] || '';
                const rawStart = row['start dates'] || row['start date'];
                const rawEnd = row['due date'] || row['end date'];

                return {
                    id: id,
                    titulo: title,
                    responsable: owner,
                    inicio: parseAzureDate(rawStart),
                    fin: parseAzureDate(rawEnd)
                };
            }).filter(t => t.inicio && t.fin);

            if (tasks.length === 0) {
                alert("No valid tasks found. Please check 'Start Dates' and 'Due Date' columns.");
                return;
            }

            renderGantt(tasks);
        }

        function splitCSVLine(line, delimiter) {
            const result = [];
            let cur = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                let char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === delimiter && !inQuotes) {
                    result.push(cur);
                    cur = '';
                } else {
                    cur += char;
                }
            }
            result.push(cur);
            return result;
        }

        function parseAzureDate(v) {
            if (!v || v === "") return null;
            const clean = v.split(' ')[0];
            const parts = clean.split(/[\/-]/);
            if (parts.length === 3) {
                let m, d, y;
                m = parts[0].padStart(2, '0');
                d = parts[1].padStart(2, '0');
                y = parts[2];
                if (y.length === 2) y = "20" + y;
                return `${y}-${m}-${d}`;
            }
            return null;
        }

        function renderGantt(tasks) {
            const body = document.getElementById('gantt-body');
            const headerMonths = document.getElementById('header-months-container');
            const headerDays = document.getElementById('header-days-container');
            const info = document.getElementById('date-range-info');
            
            body.innerHTML = '';
            headerMonths.innerHTML = '';
            headerDays.innerHTML = '';

            const allDates = tasks.flatMap(t => [new Date(t.inicio), new Date(t.fin)]);
            let minDate = new Date(Math.min(...allDates));
            let maxDate = new Date(Math.max(...allDates));

            minDate.setDate(minDate.getDate() - 2);
            maxDate.setDate(maxDate.getDate() + 5);

            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
            info.innerText = `Range: ${minDate.toLocaleDateString()} to ${maxDate.toLocaleDateString()} (${tasks.length} tasks)`;

            let currentMonth = -1;
            let monthSpan = 0;
            let monthEl = null;

            for (let i = 0; i < totalDays; i++) {
                const cur = new Date(minDate);
                cur.setDate(minDate.getDate() + i);
                
                // Month Logic
                if (cur.getMonth() !== currentMonth) {
                    currentMonth = cur.getMonth();
                    monthEl = document.createElement('div');
                    monthEl.className = 'month-cell';
                    monthEl.innerText = cur.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                    headerMonths.appendChild(monthEl);
                    monthSpan = 0;
                }
                monthSpan++;
                monthEl.style.width = `${monthSpan * dayWidth}px`;
                monthEl.style.minWidth = `${monthSpan * dayWidth}px`;

                // Day Logic
                const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;
                const dayEl = document.createElement('div');
                dayEl.className = `day-cell header-day ${isWeekend ? 'weekend' : ''}`;
                dayEl.innerHTML = `
                    <span class="text-[9px] font-black">${cur.getDate()}</span>
                    <span class="text-[7px] opacity-40 uppercase">${cur.toLocaleDateString('en-US', {weekday: 'short'})}</span>
                `;
                headerDays.appendChild(dayEl);
            }

            tasks.sort((a,b) => new Date(a.inicio) - new Date(b.inicio)).forEach(task => {
                const row = document.createElement('div');
                row.className = 'gantt-row';
                
                const label = document.createElement('div');
                label.className = 'sticky-col';
                label.innerHTML = `
                    <div class="truncate w-full">
                        <div class="flex justify-between items-center mb-0.5">
                            <span class="text-[9px] font-black text-slate-400">#${task.id}</span>
                            <span class="text-[8px] font-medium text-slate-400 truncate max-w-[120px]">${task.responsable}</span>
                        </div>
                        <div class="text-xs font-bold text-slate-700 truncate" title="${task.titulo}">${task.titulo}</div>
                    </div>
                `;
                row.appendChild(label);

                const grid = document.createElement('div');
                grid.className = 'time-grid-container';
                for(let i=0; i<totalDays; i++) {
                    const cur = new Date(minDate);
                    cur.setDate(minDate.getDate() + i);
                    const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;
                    const cell = document.createElement('div');
                    cell.className = `day-cell ${isWeekend ? 'weekend' : ''}`;
                    grid.appendChild(cell);
                }

                const dStart = new Date(task.inicio);
                const dEnd = new Date(task.fin);
                const offset = Math.floor((dStart - minDate) / (1000 * 60 * 60 * 24));
                const duration = Math.floor((dEnd - dStart) / (1000 * 60 * 60 * 24)) + 1;

                const barWrapper = document.createElement('div');
                barWrapper.className = 'gantt-bar-wrapper';
                barWrapper.style.left = `${offset * dayWidth}px`;
                barWrapper.style.width = `${duration * dayWidth}px`;

                const bar = document.createElement('div');
                bar.className = 'gantt-bar';
                bar.innerHTML = `<span class="truncate">${duration}d</span>`;
                
                barWrapper.appendChild(bar);
                grid.appendChild(barWrapper);
                row.appendChild(grid);
                body.appendChild(row);
            });

            const today = new Date();
            today.setHours(0,0,0,0);
            if (today >= minDate && today <= maxDate) {
                const offset = (today - minDate) / (1000 * 60 * 60 * 24);
                const line = document.createElement('div');
                line.className = 'today-line';
                line.style.left = `${stickyWidth + (offset * dayWidth)}px`;
                line.innerHTML = `<div class="today-label">TODAY</div>`;
                body.appendChild(line);
            }
        }

        window.onload = () => renderGantt(backupTasks);
    </script>
</body>
</html>
